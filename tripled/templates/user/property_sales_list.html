

{% extends 'user/base.html' %}

{% block title %}Property Sales{% endblock %}
{% load humanize %}

{% block body %}
<style>
/* Custom styles for development status badges */
.development-status-developed {
    background-color: #28a745 !important;
    color: white !important;
}

.development-status-expired {
    background-color: #dc3545 !important;
    color: white !important;
}

.development-status-expiring {
    background-color: #fd7e14 !important;
    color: white !important;
}

.development-status-valid {
    background-color: #17a2b8 !important;
    color: white !important;
}

.development-status-no_timeline {
    background-color: #6c757d !important;
    color: white !important;
}

/* Ensure all badges have proper contrast */
.badge {
    font-weight: 500;
    padding: 0.375rem 0.75rem;
    border-radius: 0.25rem;
}

/* Additional styling for small text under badges */
.development-status-cell small {
    font-size: 0.75rem;
    margin-top: 0.25rem;
    display: block;
}

/* Email dropdown styling */
.email-dropdown {
    position: relative;
    display: inline-block;
}

.email-dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
    border-radius: 4px;
}

.email-dropdown-content a {
    color: black;
    padding: 8px 16px;
    text-decoration: none;
    display: block;
    border-bottom: 1px solid #ddd;
}

.email-dropdown-content a:hover {
    background-color: #f1f1f1;
}

.email-dropdown:hover .email-dropdown-content {
    display: block;
}

.email-dropdown .btn {
    background: none;
    border: none;
    color: #007bff;
    cursor: pointer;
}

.email-dropdown .btn:hover {
    color: #0056b3;
}

/* Loading spinner */
.btn-loading {
    opacity: 0.6;
    pointer-events: none;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}
</style>

<div class="content-page">
  <div class="content">
    <div class="container-fluid mt-4">

      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Property Sales</h2>
        <a href="{% url 'register_property_sale' %}" class="btn btn-success">
          <i class="fas fa-plus"></i> Register New Sale
        </a>
      </div>

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Email Status Messages -->
      <div id="emailMessages"></div>

      <div class="card shadow">
        <div class="card-header bg-light">
          <div class="row">
            <div class="col-md-2">
              <div class="input-group">
                <input type="text" id="saleSearch" class="form-control" placeholder="Search sales...">
                <div class="input-group-append">
                  <button type="button" class="btn btn-primary"><i class="ri-search-line fs-16"></i></button>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <select id="propertyTypeFilter" class="form-control">
                <option value="">All Property Types</option>
                <option value="building">Building Property</option>
                <option value="land">Land</option>
              </select>
            </div>
            <div class="col-md-2">
              <select id="paymentStatusFilter" class="form-control">
                <option value="">All Payment Status</option>
                <option value="fully_paid">Fully Paid</option>
                <option value="partially_paid">Partially Paid</option>
                <option value="pending">Pending Payment</option>
              </select>
            </div>
            <div class="col-md-2">
              <select id="paymentPlanFilter" class="form-control">
                <option value="">All Payment Plans</option>
                <option value="outright">Outright Purchase</option>
                <option value="3_months">3 Months Plan</option>
                <option value="6_months">6 Months Plan</option>
              </select>
            </div>
            <div class="col-md-2">
              <select id="developmentStatusFilter" class="form-control">
                <option value="">All Development Status</option>
                <option value="developed">Developed</option>
                <option value="expired">Timeline Expired</option>
                <option value="expiring">Expiring Soon</option>
                <option value="valid">Timeline Valid</option>
                <option value="no_timeline">No Timeline Set</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="thead-light">
                <tr>
                  <th>Reference</th>
                  <th>Client</th>
                  <th>Property</th>
                  <th>Type</th>
                  <th>Selling Price</th>
                  <th>Amount Paid</th>
                  <th>Balance</th>
                  <th>Development Status</th>
                  <th>Realtor</th>
                  <th>Created By</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% if sales %}
                  {% for sale in sales %}
                    <tr class="sale-row"
                        data-property-type="{{ sale.property_type }}"
                        data-payment-plan="{{ sale.payment_plan }}"
                        data-payment-status="{% if sale.is_fully_paid %}fully_paid{% elif sale.amount_paid > 0 %}partially_paid{% else %}pending{% endif %}"
                        data-development-status="{{ sale.development_status }}">
                      <td>{{ sale.reference_number }}</td>
                      <td>{{ sale.client_name }}</td>
                      <td>{{ sale.property_item.name }}</td>
                      <td>{{ sale.get_property_type_display }}</td>
                      <td>₦{{ sale.selling_price|floatformat:2|intcomma }}</td>
                      <td>₦{{ sale.amount_paid|floatformat:2|intcomma }}</td>
                      <td>
                        {% if sale.is_fully_paid %}
                          <span class="badge badge-success">Fully Paid</span>
                        {% else %}
                          <span class="text-danger">₦{{ sale.balance_due|floatformat:2|intcomma }}</span>
                        {% endif %}
                      </td>
                      <td class="development-status-cell">
                        <span class="badge development-status-{{ sale.development_status }}">
                          {{ sale.development_status_display }}
                        </span>
                        {% if sale.development_status == 'expiring' and sale.plot_development_expiry_date %}
                          <small class="text-muted">Expires: {{ sale.plot_development_expiry_date|date:"M d, Y" }}</small>
                        {% elif sale.development_status == 'expired' and sale.plot_development_expiry_date %}
                          <small class="text-danger">Expired: {{ sale.plot_development_expiry_date|date:"M d, Y" }}</small>
                        {% elif sale.development_status == 'valid' and sale.plot_development_expiry_date %}
                          <small class="text-info">Expires: {{ sale.plot_development_expiry_date|date:"M d, Y" }}</small>
                        {% endif %}
                      </td>
                      <td>{{ sale.realtor.full_name }} {% if sale.realtor.is_executive %}<i class="ri-vip-crown-fill executive-crown ms-1"></i>{% endif %}</td>
                      <td>
                        {% if sale.created_by %}
                          <span class="badge bg-info">
                            <i class="ri-user-line me-1"></i>
                            {{ sale.created_by.get_full_name|default:sale.created_by.username }}
                          </span>
                        {% else %}
                          <span class="text-muted">Unknown</span>
                        {% endif %}
                      </td>
                      <td>{{ sale.created_at|date:"M d, Y" }}</td>
                      

                      <td>
  <a href="{% url 'property_sale_detail' sale.id %}" class="btn btn-sm btn-info">
    <i class="fas fa-eye"></i> View
  </a>
  
  <!-- Message icon for sending emails -->
  {% if sale.client_email %}
    <button type="button" class="btn btn-sm btn-primary ms-1" 
            onclick="openEmailModal({{ sale.id }}, '{{ sale.client_name }}', '{{ sale.development_status }}')"
            id="msgBtn-{{ sale.id }}"
            title="Send Email to Client">
      <i class="ri-mail-line"></i>
    </button>
  {% else %}
    <button type="button" class="btn btn-sm btn-secondary ms-1" disabled
            title="No email address available">
      <i class="ri-mail-line"></i>
    </button>
  {% endif %}
</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="12" class="text-center py-4">
                      No property sales recorded yet.
                      <a href="{% url 'register_property_sale' %}">Register your first sale</a>.
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="card-footer bg-white">
          <nav aria-label="Sales pagination">
            <ul class="pagination justify-content-center mb-0">
              {% if sales.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ sales.previous_page_number }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">&laquo;</span>
                </li>
              {% endif %}

              {% for num in sales.paginator.page_range %}
                {% if sales.number == num %}
                  <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num >= sales.number|add:-2 and num <= sales.number|add:2 %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                  </li>
                {% endif %}
              {% endfor %}

              {% if sales.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ sales.next_page_number }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">&raquo;</span>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Add this modal before the closing body tag -->
<!-- Email Modal with Fixed Close/Cancel Functionality -->
<div class="modal fade" id="emailModal" tabindex="-1" role="dialog" aria-labelledby="emailModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="emailModalLabel">Send Email to Client</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeEmailModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Send email to: <strong id="clientNameModal"></strong></p>
        <div id="emailOptions">
          <!-- Email options will be populated by JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closeEmailModal()">Cancel</button>
        <button type="button" class="btn btn-primary" id="sendEmailBtn" onclick="sendSelectedEmail()">
          <span id="sendBtnText">Send Email</span>
          <div class="spinner-border spinner-border-sm d-none" id="sendBtnSpinner" role="status"></div>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let currentSaleId = null;
  let selectedEmailType = null;

  // Search and filter logic (keep existing)
  function filterSales() {
    const searchValue = document.getElementById('saleSearch').value.toLowerCase();
    const ptFilter = document.getElementById('propertyTypeFilter').value;
    const psFilter = document.getElementById('paymentStatusFilter').value;
    const ppFilter = document.getElementById('paymentPlanFilter').value;
    const dsFilter = document.getElementById('developmentStatusFilter').value;
    
    document.querySelectorAll('.sale-row').forEach(row => {
      const text = row.textContent.toLowerCase();
      const pt = row.dataset.propertyType;
      const ps = row.dataset.paymentStatus;
      const pp = row.dataset.paymentPlan;
      const ds = row.dataset.developmentStatus;
      
      let show = text.includes(searchValue);
      if (show && ptFilter && pt !== ptFilter) show = false;
      if (show && psFilter && ps !== psFilter) show = false;
      if (show && ppFilter && pp !== ppFilter) show = false;
      if (show && dsFilter && ds !== dsFilter) show = false;
      
      row.style.display = show ? '' : 'none';
    });
  }

  document.getElementById('saleSearch').addEventListener('keyup', filterSales);
  ['propertyTypeFilter','paymentStatusFilter','paymentPlanFilter', 'developmentStatusFilter']
    .forEach(id => document.getElementById(id).addEventListener('change', filterSales));

  // Function to close the email modal
  function closeEmailModal() {
    // Reset variables
    currentSaleId = null;
    selectedEmailType = null;
    
    // Reset form
    document.getElementById('emailOptions').innerHTML = '';
    document.getElementById('clientNameModal').textContent = '';
    
    // Reset send button
    const sendBtnText = document.getElementById('sendBtnText');
    const sendBtnSpinner = document.getElementById('sendBtnSpinner');
    const sendBtn = document.getElementById('sendEmailBtn');
    
    sendBtnText.classList.remove('d-none');
    sendBtnSpinner.classList.add('d-none');
    sendBtn.disabled = false;
    
    // Close modal using Bootstrap's modal method or fallback
    if (typeof $ !== 'undefined' && $.fn.modal) {
      $('#emailModal').modal('hide');
    } else {
      // Vanilla JS fallback
      const modal = document.getElementById('emailModal');
      modal.style.display = 'none';
      modal.classList.remove('show');
      document.body.classList.remove('modal-open');
      
      // Remove backdrop
      const backdrop = document.querySelector('.modal-backdrop');
      if (backdrop) {
        backdrop.remove();
      }
    }
  }

  // Open email modal with appropriate options
  function openEmailModal(saleId, clientName, developmentStatus) {
    currentSaleId = saleId;
    document.getElementById('clientNameModal').textContent = clientName;
    
    const emailOptions = document.getElementById('emailOptions');
    let optionsHtml = '';
    
    // Show email options based on development status
    if (developmentStatus === 'valid' || developmentStatus === 'expiring') {
      optionsHtml += `
        <div class="form-check">
          <input class="form-check-input" type="radio" name="emailType" id="reminderEmail" value="reminder" checked>
          <label class="form-check-label" for="reminderEmail">
            <i class="fas fa-bell text-warning"></i> Send Development Reminder
            <small class="form-text text-muted">Remind client about development timeline requirements</small>
          </label>
        </div>
      `;
      selectedEmailType = 'reminder';
    }
    
    if (developmentStatus === 'expired') {
      optionsHtml += `
        <div class="form-check">
          <input class="form-check-input" type="radio" name="emailType" id="revocationEmail" value="revocation" checked>
          <label class="form-check-label" for="revocationEmail">
            <i class="fas fa-exclamation-triangle text-danger"></i> Send Revocation Notice
            <small class="form-text text-muted">Send official notice of plot revocation due to non-development</small>
          </label>
        </div>
      `;
      selectedEmailType = 'revocation';
    }
    
    // If multiple options, add change listener
    /*if ((developmentStatus === 'expiring') || (developmentStatus === 'valid')) {
      optionsHtml += `
        <div class="form-check mt-2">
          <input class="form-check-input" type="radio" name="emailType" id="customEmail" value="custom">
          <label class="form-check-label" for="customEmail">
            <i class="fas fa-edit text-info"></i> Custom Email
            <small class="form-text text-muted">Send a general communication email</small>
          </label>
        </div>
      `;
    }*/
    
    if (!optionsHtml) {
      optionsHtml = '<p class="text-muted">No email options available for this development status.</p>';
    }
    
    emailOptions.innerHTML = optionsHtml;
    
    // Add event listeners for radio buttons
    document.querySelectorAll('input[name="emailType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        selectedEmailType = this.value;
      });
    });
    
    // Show modal using Bootstrap or fallback
    if (typeof $ !== 'undefined' && $.fn.modal) {
      $('#emailModal').modal('show');
    } else {
      // Vanilla JS fallback
      const modal = document.getElementById('emailModal');
      modal.style.display = 'block';
      modal.classList.add('show');
      document.body.classList.add('modal-open');
      
      // Add backdrop
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop fade show';
      document.body.appendChild(backdrop);
      
      // Close on backdrop click
      backdrop.addEventListener('click', closeEmailModal);
    }
  }

  // Send selected email
  function sendSelectedEmail() {
    if (!currentSaleId || !selectedEmailType) {
      showEmailMessage(false, 'Please select an email type');
      return;
    }
    
    const sendBtn = document.getElementById('sendEmailBtn');
    const sendBtnText = document.getElementById('sendBtnText');
    const sendBtnSpinner = document.getElementById('sendBtnSpinner');
    const msgBtn = document.getElementById(`msgBtn-${currentSaleId}`);
    
    // Show loading state
    sendBtnText.classList.add('d-none');
    sendBtnSpinner.classList.remove('d-none');
    sendBtn.disabled = true;
    
    if (msgBtn) {
      msgBtn.disabled = true;
      msgBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
    }
    
    // Create FormData for POST request
    const formData = new FormData();
    formData.append('email_type', selectedEmailType);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]')?.value || '');
    
    fetch(`/send-client-email/${currentSaleId}/`, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      // Reset button states
      sendBtnText.classList.remove('d-none');
      sendBtnSpinner.classList.add('d-none');
      sendBtn.disabled = false;
      
      if (msgBtn) {
        msgBtn.disabled = false;
        msgBtn.innerHTML = '<i class="ri-mail-line"></i>';
      }
      
      // Show message and close modal
      showEmailMessage(data.success, data.message);
      closeEmailModal();
    })
    .catch(error => {
      // Reset button states
      sendBtnText.classList.remove('d-none');
      sendBtnSpinner.classList.add('d-none');
      sendBtn.disabled = false;
      
      if (msgBtn) {
        msgBtn.disabled = false;
        msgBtn.innerHTML = '<i class="ri-mail-line"></i>';
      }
      
      showEmailMessage(false, 'An error occurred while sending the email.');
      console.error('Error:', error);
      closeEmailModal();
    });
  }

  // Show email message (keep existing function)
  function showEmailMessage(success, message) {
    const messageDiv = document.getElementById('emailMessages');
    const alertClass = success ? 'alert-success' : 'alert-danger';
    const icon = success ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
    
    const alertHTML = `
      <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
        <i class="${icon}"></i> ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    `;
    
    messageDiv.innerHTML = alertHTML;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      const alert = messageDiv.querySelector('.alert');
      if (alert) {
        alert.classList.remove('show');
        setTimeout(() => {
          messageDiv.innerHTML = '';
        }, 150);
      }
    }, 5000);
  }

  // CSRF token setup (keep existing)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');
  if (csrftoken) {
    fetch.defaults = fetch.defaults || {};
    fetch.defaults.headers = fetch.defaults.headers || {};
    fetch.defaults.headers['X-CSRFToken'] = csrftoken;
  }

  // Add keyboard event listener for ESC key to close modal
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && document.getElementById('emailModal').classList.contains('show')) {
      closeEmailModal();
    }
  });
</script>


<!-- Add CSRF token for AJAX requests -->
{% csrf_token %}
{% endblock %}