{% extends 'base.html' %}
{% load humanize %}

{% block title %}Fund Allocations - Real Estate Accounting{% endblock %}

{% block content %}
<section class="content-main">
  <div class="content-header">
    <div>
      <h2 class="content-title card-title">Fund Allocations</h2>
      <p>View all fund allocations from main branch to sub branches</p>
    </div>
    <div>
      <a class="btn btn-primary" href="{% url 'accounting:allocate_funds' %}">
        <i class="material-icons md-add"></i>Allocate Funds
      </a>
    </div>
  </div>

  <!-- Info Alert -->
  <div class="alert alert-info border-info d-flex align-items-start mb-4" role="alert">
    <i class="material-icons md-info text-info me-3" style="font-size: 28px;"></i>
    <div>
      <h6 class="alert-heading mb-2">
        <i class="material-icons md-lock" style="font-size: 18px; vertical-align: middle;"></i>
        Fund Allocations Are Protected
      </h6>
      <p class="mb-2" style="font-size: 0.9em;">
        For financial integrity and audit compliance, <strong>fund allocations cannot be deleted</strong>. 
        This ensures a complete, unalterable audit trail.
      </p>
      <p class="mb-0" style="font-size: 0.9em;">
        <strong>To correct an error:</strong> Use the <span class="badge bg-warning text-dark">
        <i class="material-icons md-undo" style="font-size: 12px; vertical-align: middle;"></i> Reverse</span> button. 
        This creates offsetting transactions that return funds to the main branch while preserving complete transaction history.
      </p>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      {% if allocations %}
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>From Branch</th>
                <th>To Branch</th>
                <th>Amount</th>
                <th>Description</th>
                <th>Allocated By</th>
                <th>Status</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for allocation in allocations %}
              <tr>
                <td>{{ allocation.allocated_date|date:"M d, Y H:i" }}</td>
                <td>
                  <span class="badge bg-primary">{{ allocation.from_branch.name }}</span>
                </td>
                <td>
                  <span class="badge bg-info">{{ allocation.to_branch.name }}</span>
                </td>
                <td class="text-success">
                  <strong>₦{{ allocation.amount|intcomma }}</strong>
                </td>
                <td>
                  <div class="text-truncate" style="max-width: 200px;" title="{{ allocation.description }}">
                    {{ allocation.description }}
                  </div>
                </td>
                <td>{{ allocation.allocated_by.get_full_name }}</td>
                <td>
                  {% if allocation.is_active %}
                    <span class="badge bg-success">Active</span>
                  {% else %}
                    <span class="badge bg-secondary">Reversed</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  {% if allocation.is_active %}
                    <form method="post" action="{% url 'accounting:reverse_fund_allocation' allocation.id %}" style="display: inline;" onsubmit="return confirmReversal(event, '{{ allocation.amount|floatformat:2 }}', '{{ allocation.from_branch.name }}', '{{ allocation.to_branch.name }}')">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-warning" data-bs-toggle="tooltip" data-bs-placement="top" title="Reverse this allocation">
                        <i class="material-icons md-undo"></i> Reverse
                      </button>
                    </form>
                  {% else %}
                    <span class="text-muted small">
                      <i class="material-icons md-check_circle" style="font-size: 14px; vertical-align: middle;"></i>
                      Reversed
                    </span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center py-5">
          <i class="material-icons md-account_balance" style="font-size: 4rem; color: #ccc;"></i>
          <h5 class="mt-3 text-muted">No fund allocations found</h5>
          <p class="text-muted">Allocate funds to sub branches to get started.</p>
          <a href="{% url 'accounting:allocate_funds' %}" class="btn btn-primary">
            <i class="material-icons md-add me-2"></i>Allocate Funds
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<script>
// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl, {
      trigger: 'hover focus',
      delay: { show: 200, hide: 100 }
    });
  });
});

// Confirm reversal with detailed explanation
function confirmReversal(event, amount, fromBranch, toBranch) {
  event.preventDefault();
  
  const message = 
    `⚠️ REVERSE FUND ALLOCATION\n\n` +
    `This will reverse the allocation of ₦${parseFloat(amount).toLocaleString()} from ${fromBranch} to ${toBranch}.\n\n` +
    `What will happen:\n` +
    `✓ Funds will be returned from ${toBranch} to ${fromBranch}\n` +
    `✓ Proper accounting entries will be created for both branches\n` +
    `✓ The original allocation will be marked as "Reversed"\n` +
    `✓ Complete audit trail will be preserved\n\n` +
    `⚠️ NOTE: ${toBranch} must have sufficient balance (₦${parseFloat(amount).toLocaleString()}) to complete this reversal.\n\n` +
    `Do you want to proceed with this reversal?`;
  
  if (confirm(message)) {
    event.target.submit();
  }
  
  return false;
}
</script>
{% endblock content %}
