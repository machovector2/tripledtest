{% extends 'base.html' %}

{% block title %}Manage Categories - Triple D Homes{% endblock %}

{% block content %}
<section class="content-main">
  <div class="content-header">
    <div>
      <h2 class="content-title card-title">Manage Categories</h2>
      <p>Organize income and expenditure categories</p>
    </div>
    <div>
      <a class="btn btn-success me-2" href="{% url 'accounting:add_income_category' %}">
        <i class="material-icons md-add"></i>Add Income Category
      </a>
      <a class="btn btn-danger" href="{% url 'accounting:add_expenditure_category' %}">
        <i class="material-icons md-add"></i>Add Expenditure Category
      </a>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card card-body mb-4 shadow-sm">
        <article class="icontext">
          <span class="icon icon-sm rounded-circle bg-success-light">
            <i class="text-success material-icons md-trending_up"></i>
          </span>
          <div class="text">
            <h6 class="mb-1">Income Categories</h6>
            <span class="h4">{{ total_income_categories }}</span>
            <span class="text-sm text-muted d-block">Active categories</span>
          </div>
        </article>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card card-body mb-4 shadow-sm">
        <article class="icontext">
          <span class="icon icon-sm rounded-circle bg-danger-light">
            <i class="text-danger material-icons md-trending_down"></i>
          </span>
          <div class="text">
            <h6 class="mb-1">Expenditure Categories</h6>
            <span class="h4">{{ total_expenditure_categories }}</span>
            <span class="text-sm text-muted d-block">Active categories</span>
          </div>
        </article>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card card-body mb-4 shadow-sm">
        <article class="icontext">
          <span class="icon icon-sm rounded-circle bg-info-light">
            <i class="text-info material-icons md-receipt_long"></i>
          </span>
          <div class="text">
            <h6 class="mb-1">Income Transactions</h6>
            <span class="h4">{{ total_income_transactions }}</span>
            <span class="text-sm text-muted d-block">Total recorded</span>
          </div>
        </article>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card card-body mb-4 shadow-sm">
        <article class="icontext">
          <span class="icon icon-sm rounded-circle bg-warning-light">
            <i class="text-warning material-icons md-receipt"></i>
          </span>
          <div class="text">
            <h6 class="mb-1">Expenditure Transactions</h6>
            <span class="h4">{{ total_expenditure_transactions }}</span>
            <span class="text-sm text-muted d-block">Total recorded</span>
          </div>
        </article>
      </div>
    </div>
  </div>

  <!-- Search and Filter Bar -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-5">
          <div class="input-group">
            <span class="input-group-text"><i class="material-icons md-search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="Search categories by name or description..." onkeyup="filterCategories()">
          </div>
        </div>
        <div class="col-md-3">
          <select class="form-control" id="scopeFilter" onchange="filterCategories()">
            <option value="">All Scopes</option>
            <option value="all">All Branches</option>
            <option value="main">Main Branch Only</option>
            <option value="sub">Sub Branches Only</option>
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-control" id="sortBy" onchange="sortCategories()">
            <option value="usage">Sort by Usage</option>
            <option value="name">Sort by Name</option>
            <option value="date">Sort by Date</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
            <i class="material-icons md-refresh"></i> Reset
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Income Categories -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center bg-success-light">
          <h5 class="card-title text-success mb-0">
            <i class="material-icons md-trending_up me-2"></i>Income Categories
          </h5>
          <span class="badge bg-success" id="incomeCount">{{ income_categories.count }}</span>
        </div>
        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
          {% if income_categories %}
            <div class="list-group list-group-flush" id="incomeList">
              {% for category in income_categories %}
              <div class="list-group-item category-item income-category border-0 mb-2 rounded hover-shadow" 
                   data-name="{{ category.name|lower }}" 
                   data-description="{{ category.description|lower }}"
                   data-scope="{{ category.scope }}"
                   data-usage="{{ category.transaction_count }}"
                   data-date="{{ category.id }}">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1" style="cursor: pointer;" onclick="editIncomeCategory({{ category.id }})">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="fw-bold text-dark">{{ category.name }}</div>
                      <div class="badge bg-light text-dark ms-2">
                        <i class="material-icons md-receipt_long" style="font-size: 14px; vertical-align: middle;"></i>
                        {{ category.transaction_count }} transaction{{ category.transaction_count|pluralize }}
                      </div>
                    </div>
                    {% if category.description %}
                      <small class="text-muted d-block mt-1">{{ category.description|truncatechars:100 }}</small>
                    {% endif %}
                    <div class="mt-2">
                      <span class="badge bg-info me-1">{{ category.get_scope_display }}</span>
                      {% if category.branch %}
                        <span class="badge bg-secondary me-1">{{ category.branch.name }}</span>
                      {% endif %}
                      <small class="text-muted ms-2">
                        <i class="material-icons md-person" style="font-size: 14px; vertical-align: middle;"></i>
                        {{ category.created_by.get_full_name|default:category.created_by.username }}
                      </small>
                    </div>
                  </div>
                  {% if category.created_by == user or user.user_type == 'admin' or user.user_type == 'chief_accountant' %}
                  <div class="btn-group btn-group-sm ms-2" role="group" onclick="event.stopPropagation();">
                    <button type="button" class="btn btn-outline-primary btn-sm" title="Edit" onclick="editIncomeCategory({{ category.id }})">
                      <i class="material-icons md-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" title="Delete" 
                            onclick="confirmDeleteIncomeCategory({{ category.id }}, '{{ category.name|escapejs }}')">
                      <i class="material-icons md-delete"></i>
                    </button>
                  </div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
            <div id="incomeNoResults" class="text-center py-4" style="display: none;">
              <i class="material-icons md-search_off" style="font-size: 3rem; color: #ccc;"></i>
              <p class="text-muted mt-2">No income categories match your search.</p>
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="material-icons md-category" style="font-size: 3rem; color: #ccc;"></i>
              <p class="text-muted mt-2">No income categories created yet.</p>
              <a href="{% url 'accounting:add_income_category' %}" class="btn btn-success btn-sm">
                <i class="material-icons md-add me-2"></i>Add Income Category
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Expenditure Categories -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center bg-danger-light">
          <h5 class="card-title text-danger mb-0">
            <i class="material-icons md-trending_down me-2"></i>Expenditure Categories
          </h5>
          <span class="badge bg-danger" id="expenditureCount">{{ expenditure_categories.count }}</span>
        </div>
        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
          {% if expenditure_categories %}
            <div class="list-group list-group-flush" id="expenditureList">
              {% for category in expenditure_categories %}
              <div class="list-group-item category-item expenditure-category border-0 mb-2 rounded hover-shadow" 
                   data-name="{{ category.name|lower }}" 
                   data-description="{{ category.description|lower }}"
                   data-scope="{{ category.scope }}"
                   data-usage="{{ category.transaction_count }}"
                   data-date="{{ category.id }}">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1" style="cursor: pointer;" onclick="editExpenditureCategory({{ category.id }})">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="fw-bold text-dark">{{ category.name }}</div>
                      <div class="badge bg-light text-dark ms-2">
                        <i class="material-icons md-receipt_long" style="font-size: 14px; vertical-align: middle;"></i>
                        {{ category.transaction_count }} transaction{{ category.transaction_count|pluralize }}
                      </div>
                    </div>
                    {% if category.description %}
                      <small class="text-muted d-block mt-1">{{ category.description|truncatechars:100 }}</small>
                    {% endif %}
                    <div class="mt-2">
                      <span class="badge bg-info me-1">{{ category.get_scope_display }}</span>
                      {% if category.branch %}
                        <span class="badge bg-secondary me-1">{{ category.branch.name }}</span>
                      {% endif %}
                      <small class="text-muted ms-2">
                        <i class="material-icons md-person" style="font-size: 14px; vertical-align: middle;"></i>
                        {{ category.created_by.get_full_name|default:category.created_by.username }}
                      </small>
                    </div>
                  </div>
                  {% if category.created_by == user or user.user_type == 'admin' or user.user_type == 'chief_accountant' %}
                  <div class="btn-group btn-group-sm ms-2" role="group" onclick="event.stopPropagation();">
                    <button type="button" class="btn btn-outline-primary btn-sm" title="Edit" onclick="editExpenditureCategory({{ category.id }})">
                      <i class="material-icons md-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" title="Delete" 
                            onclick="confirmDeleteExpenditureCategory({{ category.id }}, '{{ category.name|escapejs }}')">
                      <i class="material-icons md-delete"></i>
                    </button>
                  </div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
            <div id="expenditureNoResults" class="text-center py-4" style="display: none;">
              <i class="material-icons md-search_off" style="font-size: 3rem; color: #ccc;"></i>
              <p class="text-muted mt-2">No expenditure categories match your search.</p>
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="material-icons md-category" style="font-size: 3rem; color: #ccc;"></i>
              <p class="text-muted mt-2">No expenditure categories created yet.</p>
              <a href="{% url 'accounting:add_expenditure_category' %}" class="btn btn-danger btn-sm">
                <i class="material-icons md-add me-2"></i>Add Expenditure Category
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Edit Income Category Modal -->
<div class="modal fade" id="editIncomeCategoryModal" tabindex="-1" aria-labelledby="editIncomeCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editIncomeCategoryModalLabel">Edit Income Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editIncomeCategoryForm">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" id="edit_income_category_id" name="category_id">
          <div class="mb-3">
            <label for="edit_income_name" class="form-label">Category Name *</label>
            <input type="text" class="form-control" id="edit_income_name" name="name" required>
          </div>
          <div class="mb-3">
            <label for="edit_income_description" class="form-label">Description</label>
            <textarea class="form-control" id="edit_income_description" name="description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="edit_income_scope" class="form-label">Scope *</label>
            <select class="form-control" id="edit_income_scope" name="scope" required>
              <option value="all">All Branches</option>
              <option value="main">Main Branch Only</option>
              <option value="sub">Sub Branches Only</option>
            </select>
          </div>
          {% if user.user_type == 'admin' or user.user_type == 'admin' or user.user_type == 'chief_accountant' %}
          <div class="mb-3">
            <label for="edit_income_branch" class="form-label">Branch (Optional)</label>
            <select class="form-control" id="edit_income_branch" name="branch">
              <option value="">-- Leave empty for global category --</option>
              {% for branch in branches %}
                <option value="{{ branch.id }}">{{ branch.name }}</option>
              {% endfor %}
            </select>
            <small class="form-text text-muted">Leave empty for global categories</small>
          </div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="incomeSaveSpinner"></span>
            Update Category
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Expenditure Category Modal -->
<div class="modal fade" id="editExpenditureCategoryModal" tabindex="-1" aria-labelledby="editExpenditureCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editExpenditureCategoryModalLabel">Edit Expenditure Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editExpenditureCategoryForm">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" id="edit_expenditure_category_id" name="category_id">
          <div class="mb-3">
            <label for="edit_expenditure_name" class="form-label">Category Name *</label>
            <input type="text" class="form-control" id="edit_expenditure_name" name="name" required>
          </div>
          <div class="mb-3">
            <label for="edit_expenditure_description" class="form-label">Description</label>
            <textarea class="form-control" id="edit_expenditure_description" name="description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="edit_expenditure_scope" class="form-label">Scope *</label>
            <select class="form-control" id="edit_expenditure_scope" name="scope" required>
              <option value="all">All Branches</option>
              <option value="main">Main Branch Only</option>
              <option value="sub">Sub Branches Only</option>
            </select>
          </div>
          {% if user.user_type == 'admin' or user.user_type == 'admin' or user.user_type == 'chief_accountant' %}
          <div class="mb-3">
            <label for="edit_expenditure_branch" class="form-label">Branch (Optional)</label>
            <select class="form-control" id="edit_expenditure_branch" name="branch">
              <option value="">-- Leave empty for global category --</option>
              {% for branch in branches %}
                <option value="{{ branch.id }}">{{ branch.name }}</option>
              {% endfor %}
            </select>
            <small class="form-text text-muted">Leave empty for global categories</small>
          </div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="expenditureSaveSpinner"></span>
            Update Category
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteCategoryModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the category "<strong id="delete_category_name"></strong>"?</p>
        <p class="text-danger"><small><i class="material-icons md-warning" style="font-size: 16px; vertical-align: middle;"></i> This action cannot be undone.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteCategoryForm" method="POST" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <i class="material-icons md-delete me-2"></i>Delete Category
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
.hover-shadow {
  transition: all 0.3s ease;
}

.hover-shadow:hover {
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.category-item {
  background: #fff;
  border: 1px solid #e9ecef !important;
  transition: all 0.3s ease;
}

.category-item:hover {
  border-color: #dee2e6 !important;
  background: #f8f9fa;
}

.bg-success-light {
  background-color: #d4edda;
}

.bg-danger-light {
  background-color: #f8d7da;
}

.bg-info-light {
  background-color: #d1ecf1;
}

.bg-warning-light {
  background-color: #fff3cd;
}

.card {
  border: none;
}

.shadow-sm {
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
}

.list-group-item {
  padding: 1rem;
}

/* Scrollbar styling */
.card-body::-webkit-scrollbar {
  width: 8px;
}

.card-body::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.card-body::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 10px;
}

.card-body::-webkit-scrollbar-thumb:hover {
  background: #555;
}
</style>

<script>
// Search and Filter functionality
function filterCategories() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const scopeFilter = document.getElementById('scopeFilter').value;
  
  filterCategoryType('income', searchTerm, scopeFilter);
  filterCategoryType('expenditure', searchTerm, scopeFilter);
}

function filterCategoryType(type, searchTerm, scopeFilter) {
  const items = document.querySelectorAll(`.${type}-category`);
  let visibleCount = 0;
  
  items.forEach(item => {
    const name = item.getAttribute('data-name');
    const description = item.getAttribute('data-description');
    const scope = item.getAttribute('data-scope');
    
    const matchesSearch = name.includes(searchTerm) || description.includes(searchTerm);
    const matchesScope = !scopeFilter || scope === scopeFilter;
    
    if (matchesSearch && matchesScope) {
      item.style.display = '';
      visibleCount++;
    } else {
      item.style.display = 'none';
    }
  });
  
  // Update count and show/hide no results message
  const countBadge = document.getElementById(`${type}Count`);
  const noResults = document.getElementById(`${type}NoResults`);
  
  if (countBadge) {
    countBadge.textContent = visibleCount;
  }
  
  if (noResults) {
    noResults.style.display = visibleCount === 0 ? 'block' : 'none';
  }
}

// Sort functionality
function sortCategories() {
  const sortBy = document.getElementById('sortBy').value;
  
  sortCategoryType('incomeList', sortBy);
  sortCategoryType('expenditureList', sortBy);
}

function sortCategoryType(listId, sortBy) {
  const list = document.getElementById(listId);
  if (!list) return;
  
  const items = Array.from(list.querySelectorAll('.category-item'));
  
  items.sort((a, b) => {
    if (sortBy === 'name') {
      return a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'));
    } else if (sortBy === 'usage') {
      return parseInt(b.getAttribute('data-usage')) - parseInt(a.getAttribute('data-usage'));
    } else if (sortBy === 'date') {
      return parseInt(b.getAttribute('data-date')) - parseInt(a.getAttribute('data-date'));
    }
    return 0;
  });
  
  items.forEach(item => list.appendChild(item));
}

// Reset filters
function resetFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('scopeFilter').value = '';
  document.getElementById('sortBy').value = 'usage';
  filterCategories();
  sortCategories();
}

// Edit Income Category
function editIncomeCategory(categoryId) {
  fetch(`/accounting/edit-income-category/${categoryId}/`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('edit_income_category_id').value = data.id;
      document.getElementById('edit_income_name').value = data.name;
      document.getElementById('edit_income_description').value = data.description || '';
      document.getElementById('edit_income_scope').value = data.scope;
      
      // Set branch dropdown if chief accountant
      {% if user.user_type == 'admin' or user.user_type == 'admin' or user.user_type == 'chief_accountant' %}
      const branchSelect = document.getElementById('edit_income_branch');
      if (branchSelect) {
        branchSelect.value = data.branch || '';
      }
      {% endif %}
      
      const modal = new bootstrap.Modal(document.getElementById('editIncomeCategoryModal'));
      modal.show();
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error loading category data');
    });
}

// Edit Expenditure Category
function editExpenditureCategory(categoryId) {
  fetch(`/accounting/edit-expenditure-category/${categoryId}/`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('edit_expenditure_category_id').value = data.id;
      document.getElementById('edit_expenditure_name').value = data.name;
      document.getElementById('edit_expenditure_description').value = data.description || '';
      document.getElementById('edit_expenditure_scope').value = data.scope;
      
      // Set branch dropdown if chief accountant
      {% if user.user_type == 'admin' or user.user_type == 'admin' or user.user_type == 'chief_accountant' %}
      const branchSelect = document.getElementById('edit_expenditure_branch');
      if (branchSelect) {
        branchSelect.value = data.branch || '';
      }
      {% endif %}
      
      const modal = new bootstrap.Modal(document.getElementById('editExpenditureCategoryModal'));
      modal.show();
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error loading category data');
    });
}

// Delete Income Category
function confirmDeleteIncomeCategory(categoryId, categoryName) {
  document.getElementById('delete_category_name').textContent = categoryName;
  document.getElementById('deleteCategoryForm').action = `/accounting/delete-income-category/${categoryId}/`;
  const modal = new bootstrap.Modal(document.getElementById('deleteCategoryModal'));
  modal.show();
}

// Delete Expenditure Category
function confirmDeleteExpenditureCategory(categoryId, categoryName) {
  document.getElementById('delete_category_name').textContent = categoryName;
  document.getElementById('deleteCategoryForm').action = `/accounting/delete-expenditure-category/${categoryId}/`;
  const modal = new bootstrap.Modal(document.getElementById('deleteCategoryModal'));
  modal.show();
}

// Handle form submissions with loading states
document.getElementById('editIncomeCategoryForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const categoryId = document.getElementById('edit_income_category_id').value;
  const spinner = document.getElementById('incomeSaveSpinner');
  formData.delete('category_id');
  
  spinner.classList.remove('d-none');
  
  fetch(`/accounting/edit-income-category/${categoryId}/`, {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': formData.get('csrfmiddlewaretoken')
    }
  })
  .then(response => response.json())
  .then(data => {
    spinner.classList.add('d-none');
    if (data.success) {
      bootstrap.Modal.getInstance(document.getElementById('editIncomeCategoryModal')).hide();
      location.reload();
    } else {
      let errorMsg = 'Error updating category:\n';
      if (data.errors) {
        for (let field in data.errors) {
          errorMsg += field + ': ' + data.errors[field].join(', ') + '\n';
        }
      }
      alert(errorMsg);
    }
  })
  .catch(error => {
    spinner.classList.add('d-none');
    console.error('Error:', error);
    alert('Error updating category');
  });
});

document.getElementById('editExpenditureCategoryForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const categoryId = document.getElementById('edit_expenditure_category_id').value;
  const spinner = document.getElementById('expenditureSaveSpinner');
  formData.delete('category_id');
  
  spinner.classList.remove('d-none');
  
  fetch(`/accounting/edit-expenditure-category/${categoryId}/`, {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': formData.get('csrfmiddlewaretoken')
    }
  })
  .then(response => response.json())
  .then(data => {
    spinner.classList.add('d-none');
    if (data.success) {
      bootstrap.Modal.getInstance(document.getElementById('editExpenditureCategoryModal')).hide();
      location.reload();
    } else {
      let errorMsg = 'Error updating category:\n';
      if (data.errors) {
        for (let field in data.errors) {
          errorMsg += field + ': ' + data.errors[field].join(', ') + '\n';
        }
      }
      alert(errorMsg);
    }
  })
  .catch(error => {
    spinner.classList.add('d-none');
    console.error('Error:', error);
    alert('Error updating category');
  });
});
</script>
{% endblock content %}
