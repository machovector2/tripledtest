{% extends 'base.html' %}
{% load humanize %}

{% block title %}Financial Reports - Real Estate Accounting{% endblock %}

{% block content %}
<section class="content-main">
  <div class="content-header">
    <div>
      <h2 class="content-title card-title">Financial Reports</h2>
      <p>Comprehensive financial analysis and insights</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-success no-print" onclick="window.print()">
        <i class="material-icons md-print"></i>Print Report
      </button>
      <button class="btn btn-danger no-print" onclick="downloadPDF()">
        <i class="material-icons md-download"></i>Download PDF
      </button>
    </div>
  </div>

  <!-- Date Range Filter -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="card-title">Report Filters</h5>
    </div>
    <div class="card-body">
      <form method="get" class="row g-3">
        {% if user.user_type == 'admin' or user.user_type == 'chief_accountant' %}
        <div class="col-md-3">
          <label class="form-label">Branch</label>
          <select name="branch" class="form-control">
            <option value="">All Branches</option>
            {% for branch in branches %}
              <option value="{{ branch.id }}" {% if selected_branch == branch.id|stringformat:"s" %}selected{% endif %}>
                {{ branch.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        <div class="col-md-3">
          <label class="form-label">Start Date</label>
          <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">End Date</label>
          <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Report Type</label>
          <select name="report_type" class="form-control">
            <option value="overview" {% if report_type == 'overview' %}selected{% endif %}>Overview</option>
            <option value="detailed" {% if report_type == 'detailed' %}selected{% endif %}>Detailed Analysis</option>
            <option value="trends" {% if report_type == 'trends' %}selected{% endif %}>Trends & Patterns</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2">Generate Report</button>
          <a href="{% url 'accounting:reports' %}" class="btn btn-outline-secondary">Reset</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Key Metrics Cards -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card card-body mb-4 shadow-sm border-0 border-start border-4 border-success metrics-card">
        <article class="icontext">
          <span class="icon icon-sm rounded-circle bg-success-light">
            <i class="text-success material-icons md-trending_up"></i>
          </span>
          <div class="text">
            <h6 class="mb-1 card-title text-muted">Total Income</h6>
            <span class="h3 text-success">₦{{ total_income|intcomma }}</span>
            <span class="text-sm text-muted d-block fw-bold">{{ income_count }} transactions</span>
          </div>
        </article>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card card-body mb-4 shadow-sm border-0 border-start border-4 border-danger metrics-card">
        <article class="icontext">
          <span class="icon icon-sm rounded-circle bg-danger-light">
            <i class="text-danger material-icons md-trending_down"></i>
          </span>
          <div class="text">
            <h6 class="mb-1 card-title text-muted">Total Expenditure</h6>
            <span class="h3 text-danger">₦{{ total_expenditure|intcomma }}</span>
            <span class="text-sm text-muted d-block fw-bold">{{ expenditure_count }} transactions</span>
          </div>
        </article>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card card-body mb-4 shadow-sm border-0 border-start border-4 border-primary metrics-card">
        <article class="icontext">
          <span class="icon icon-sm rounded-circle {% if net_balance >= 0 %}bg-success-light{% else %}bg-danger-light{% endif %}">
            <i class="{% if net_balance >= 0 %}text-success{% else %}text-danger{% endif %} material-icons md-account_balance_wallet"></i>
          </span>
          <div class="text">
            <h6 class="mb-1 card-title text-muted">Net Balance</h6>
            <span class="h3 {% if net_balance >= 0 %}text-success{% else %}text-danger{% endif %}">₦{{ net_balance|intcomma }}</span>
            <span class="text-sm text-muted d-block fw-bold">Period result</span>
          </div>
        </article>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card card-body mb-4 shadow-sm border-0 border-start border-4 border-info metrics-card">
        <article class="icontext">
          <span class="icon icon-sm rounded-circle bg-info-light">
            <i class="text-info material-icons md-receipt_long"></i>
          </span>
          <div class="text">
            <h6 class="mb-1 card-title text-muted">Transaction Count</h6>
            <span class="h3 text-info">{{ total_transactions|intcomma }}</span>
            <span class="text-sm text-muted d-block fw-bold">Avg: ₦{{ average_transaction_value|intcomma }}</span>
          </div>
        </article>
      </div>
    </div>
  </div>

  <!-- Detailed Analysis Section (Only for detailed report) -->
  {% if report_type == 'detailed' and full_transactions %}
  <div class="card mb-4 border-0 shadow-sm print-section">
    <div class="card-header bg-white border-bottom py-3">
        <h5 class="card-title mb-0 d-flex align-items-center">
            <i class="material-icons md-list_alt text-primary me-2"></i>
            Full Transaction Audit Log
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm align-middle mb-0" id="detailedAuditTable">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-3 py-3">Date</th>
                        <th>Reference</th>
                        {% if not selected_branch %}<th>Branch</th>{% endif %}
                        <th>Category</th>
                        <th>Description</th>
                        <th class="text-end pe-3">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trans in full_transactions %}
                    <tr>
                        <td class="ps-3">
                            <span class="fw-bold">{{ trans.date|date:"Y-m-d" }}</span>
                            <br><small class="text-muted">{{ trans.created_date|date:"H:i" }}</small>
                        </td>
                        <td>
                            <small class="text-muted">#{{ trans.id }}</small>
                            <br><span class="badge {% if trans.transaction_type == 'income' %}bg-success-light text-success{% else %}bg-danger-light text-danger{% endif %}">
                                {{ trans.transaction_type|title }}
                            </span>
                        </td>
                        {% if not selected_branch %}
                        <td>{{ trans.branch.name|truncatechars:15 }}</td>
                        {% endif %}
                        <td>
                            <small class="text-dark fw-bold">
                                {{ trans.income_category.name|default:trans.expenditure_category.name|default:"Uncategorized" }}
                            </small>
                        </td>
                        <td>
                            <small class="text-muted">{{ trans.description|truncatechars:100 }}</small>
                            {% if trans.fund_allocation %}
                            <br><span class="badge bg-info-light text-info" style="font-size: 10px;">
                                <i class="material-icons md-sync" style="font-size: 10px; vertical-align: middle;"></i> Allocation #{{ trans.fund_allocation.id }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="text-end pe-3">
                            <span class="{% if trans.transaction_type == 'income' %}text-success{% else %}text-danger{% endif %} fw-bold">
                                {% if trans.transaction_type == 'income' %}+{% else %}-{% endif %}₦{{ trans.amount|intcomma }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
  </div>
  {% endif %}

  <div class="row mb-4">
    <!-- Top Categories Analysis -->
    <div class="col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-bottom">
          <h5 class="card-title mb-0">Income By Category</h5>
        </div>
        <div class="card-body">
          {% if income_categories %}
            {% for category in income_categories %}
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="fw-bold text-dark">{{ category.income_category__name|default:"Uncategorized" }}</span>
                <span class="text-success fw-bold">₦{{ category.total|intcomma }} ({{ category.percentage|floatformat:1 }}%)</span>
              </div>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ category.percentage }}%"></div>
              </div>
              <small class="text-muted">{{ category.count }} transactions</small>
            </div>
            {% endfor %}
          {% else %}
            <p class="text-muted text-center py-4">No income data for this period</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Expenditure Categories -->
    <div class="col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-bottom">
          <h5 class="card-title mb-0">Expenditure By Category</h5>
        </div>
        <div class="card-body">
          {% if expenditure_categories %}
            {% for category in expenditure_categories %}
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="fw-bold text-dark">{{ category.expenditure_category__name|default:"Uncategorized" }}</span>
                <span class="text-danger fw-bold">₦{{ category.total|intcomma }} ({{ category.percentage|floatformat:1 }}%)</span>
              </div>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-danger" role="progressbar" style="width: {{ category.percentage }}%"></div>
              </div>
              <small class="text-muted">{{ category.count }} transactions</small>
            </div>
            {% endfor %}
          {% else %}
            <p class="text-muted text-center py-4">No expenditure data for this period</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Trends Analysis -->
  <div class="row mb-4">
    <div class="col-md-{% if branch_performance %}8{% else %}12{% endif %}">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
          <h5 class="card-title mb-0">Weekly Financial Trends</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="bg-light">
                <tr>
                  <th>Range</th>
                  <th class="text-end text-success">Income</th>
                  <th class="text-end text-danger">Expenditure</th>
                  <th class="text-end">Net</th>
                </tr>
              </thead>
              <tbody>
                {% for week in weekly_trends %}
                <tr>
                  <td><span class="fw-bold text-primary">{{ week.label }}</span></td>
                  <td class="text-end text-success">₦{{ week.income|intcomma }}</td>
                  <td class="text-end text-danger">₦{{ week.expenditure|intcomma }}</td>
                  <td class="text-end {% if week.net >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                    ₦{{ week.net|intcomma }}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    {% if branch_performance %}
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-bottom text-center">
                <h5 class="card-title mb-0">Branch Contribution</h5>
            </div>
            <div class="card-body">
                {% for b_data in branch_performance %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between small">
                        <span>{{ b_data.branch.name|truncatechars:20 }}</span>
                        <span class="{% if b_data.net >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                            ₦{{ b_data.net|intcomma }}
                        </span>
                    </div>
                </div>
                {% endfor %}
                <hr>
                <div class="text-center">
                    <small class="text-muted">Net totals per branch for selected period</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
  </div>

  <!-- Summary Card -->
  <div class="card border-0 shadow-sm mb-4 print-summary">
    <div class="card-header bg-light-blue py-3">
      <h5 class="card-title mb-0">Accountant's Executive Summary</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4 text-center border-end">
          <small class="text-muted text-uppercase fw-bold">Period Revenue</small>
          <h2 class="text-success mb-1">₦{{ total_income|intcomma }}</h2>
          <span class="badge bg-success-light text-success">{{ income_count }} Inflow Sources</span>
        </div>
        <div class="col-md-4 text-center border-end">
          <small class="text-muted text-uppercase fw-bold">Period Outflow</small>
          <h2 class="text-danger mb-1">₦{{ total_expenditure|intcomma }}</h2>
          <span class="badge bg-danger-light text-danger">{{ expenditure_count }} Expense Points</span>
        </div>
        <div class="col-md-4 text-center">
          <small class="text-muted text-uppercase fw-bold">Retained Earnings</small>
          <h2 class="{% if net_balance >= 0 %}text-success{% else %}text-danger{% endif %} mb-1">₦{{ net_balance|intcomma }}</h2>
          <p class="mb-0 small text-muted">Financial Result for {{ start_date }} to {{ end_date }}</p>
        </div>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm print-footer">
    <div class="card-body py-4 bg-light d-flex justify-content-between align-items-center">
        <div>
            <p class="mb-0 text-muted small">Generated By: <strong>{{ user.get_full_name|default:user.username }}</strong></p>
            <p class="mb-0 text-muted small">System Date: {% now "Y-m-d H:i:s" %}</p>
        </div>
        <div class="text-end">
            <h5 class="text-primary mb-0">TRIPLE D HOMES</h5>
            <small class="text-muted">Financial Reporting Module 2.0</small>
        </div>
    </div>
  </div>
</section>

<!-- Include html2pdf library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
function downloadPDF() {
  const element = document.querySelector('.content-main');
  
  // Header to add for PDF only
  const pdfHeader = document.createElement('div');
  pdfHeader.className = 'pdf-header-only text-center mb-4';
  pdfHeader.innerHTML = `
    <h1 style="color: #2c3e50; font-family: 'Inter', sans-serif;">TRIPLE D HOMES</h1>
    <h3 style="color: #7f8c8d;">Financial Performance Report</h3>
    <p style="border-bottom: 2px solid #3498db; padding-bottom: 10px;">
      Report Period: ${document.querySelector('[name="start_date"]').value} to ${document.querySelector('[name="end_date"]').value}
    </p>
  `;
  
  element.prepend(pdfHeader);
  
  const opt = {
    margin:       [0.5, 0.5, 0.5, 0.5],
    filename:     `TripleD_Financial_Report_${new Date().toISOString().split('T')[0]}.pdf`,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS: true, logging: false },
    jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' },
    pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
  };

  html2pdf().set(opt).from(element).save().then(() => {
    element.removeChild(pdfHeader);
  });
}
</script>

<style>
.bg-light-blue { background-color: #f0f7ff; }
.bg-success-light { background-color: #e6fdf1; }
.bg-danger-light { background-color: #ffeff1; }
.bg-info-light { background-color: #e7f6ff; }
.metrics-card { transition: transform 0.2s; }
.metrics-card:hover { transform: translateY(-3px); }

@media screen {
    .pdf-header-only { display: none; }
}

@media print {
  /* Hide UI elements */
  .btn, .no-print, .card-header select, .card-header .btn-group, form, .form-label, .mb-4.card {
    display: none !important;
  }
  
  body {
    background: white !important;
    padding: 0 !important;
    color: black !important;
  }

  .content-main {
    padding: 0 !important;
  }
  
  /* Show professional header */
  .content-main::before {
    content: "TRIPLE D HOMES - FINANCIAL REPORT";
    display: block;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
    border-bottom: 3px double #333;
    padding-bottom: 10px;
  }
  
  .card {
    border: 1px solid #ddd !important;
    box-shadow: none !important;
    margin-bottom: 20px !important;
    break-inside: avoid;
  }
  
  .card-header {
    background-color: #f8f9fa !important;
    color: #000 !important;
    border-bottom: 1px solid #000 !important;
    text-align: left !important;
  }
  
  .table {
    width: 100% !important;
    font-size: 10px !important;
  }
  
  .table thead th {
    background-color: #333 !important;
    color: white !important;
    -webkit-print-color-adjust: exact !important;
  }
  
  .badge {
    border: 1px solid #eee !important;
    -webkit-print-color-adjust: exact !important;
  }
  
  .progress { height: 15px !important; border: 1px solid #ddd !important; -webkit-print-color-adjust: exact !important; }
  .progress-bar { -webkit-print-color-adjust: exact !important; }
  
  .text-success { color: #1a7f37 !important; }
  .text-danger { color: #cf222e !important; }
  
  .metrics-card {
    width: 48% !important;
    display: inline-block !important;
    margin: 1% !important;
    border-left: 5px solid #333 !important;
  }
  
  .row { display: block !important; }
  .col-md-6, .col-lg-3 { 
    width: 100% !important; 
    margin-bottom: 15px !important;
  }

  /* Detailed Table specific printing */
  #detailedAuditTable {
    font-size: 9px !important;
  }

  .print-summary {
    background-color: #f0f7ff !important;
    -webkit-print-color-adjust: exact !important;
  }
}
</style>
{% endblock content %}
